<!doctype html>
<html lang="en">
  <head>
    <title>Ollivander Shop - Api Rest</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  </head>
  <body>

    <button id="inventario" type="button" class="btn btn-primary">Mostrar todo el inventario</button>
    <button id="passoneday" type="button" class="btn btn-primary">Pasar un dia</button>
    <div class="col-auto">
        <table class="table table-striped">
            <thead>
                <tr>
                  <th scope="col">Nombre</th>
                  <th scope="col">Sell_in</th>
                  <th scope="col">Quality</th>
                </tr>
            </thead>
            <tbody id="Items">
    
            </tbody>
        </table>
    </div>

    <form class="add-item">
        <input id="name" name="name" type="text"/>
        <input id="sellin" name="sell_in" type="text"/>
        <input id="quality" name="quality" type="text"/>
        <button id="addItem" type="submit" class="btn btn-primary">AÃ±adir Item</button>
        <button id="deleteItem" type="button" class="btn btn-primary">Eliminar Item</button>
        <button id="reset" type="reset" class="btn btn-primary">Reset</button>
    </form>
    <script>
        const updateButton = document.querySelector('#passoneday');
        updateButton.addEventListener("click", updateQuality);

        function updateQuality() {

            var miHeaders = new Headers();

            var miInit = { method: 'GET',
                           headers: miHeaders,
                           mode: 'cors',
                           // cambiarlo a force-cache => carga del disco
                           cache: 'default' };


            fetch('http://127.0.0.1:5000/update-quality', miInit)
                .then((response) => {
                    if(response.ok) {
                        console.log("Response Status:", response.status);
                        console.log("Reponse statuts text:", response.statusText);
                        response.json().then((json) => logItemsUpdated(json))
                    } else {
                        console.log("Response Status:", response.status);
                        console.log("Reponse statuts text:", response.statusText);  
                    }  
                })
                .catch((error) => {
                    console.log(error.message);
                });
        }

        // intentar cachear con la cabecera mirando network de chrome

        function logItemsUpdated(items) {
            const itemsList = document.querySelector('#Items');
            Items.innerHTML = items.map((item, i) => {
                return `
                        <tr> <td> ${item.name} </td> 
                            <td> ${item.sell_in}  </td>
                            <td> ${item.quality}  </td>
                        </tr>
                        `;
            }).join('');
        }

        const inventButton = document.querySelector('#inventario');
        inventButton.addEventListener("click", inventario);

        function inventario() {

            var miHeaders = new Headers();

            var miInit = { method: 'GET',
                           headers: miHeaders,
                           mode: 'cors',
                           // cambiarlo a force-cache => carga del disco
                           cache: 'default' };


            fetch('http://127.0.0.1:5000/inventario', miInit)
                .then((response) => {
                    if(response.ok) {
                        console.log("Response Status:", response.status);
                        console.log("Reponse statuts text:", response.statusText);
                        response.json().then((json) => logItems(json))
                    } else {
                        console.log("Response Status:", response.status);
                        console.log("Reponse statuts text:", response.statusText);  
                    }  
                })
                .catch((error) => {
                    console.log(error.message);
                });
        }

        // intentar cachear con la cabecera mirando network de chrome

        function logItems(items) {
            const itemsList = document.querySelector('#Items');
            Items.innerHTML = items.map((item, i) => {
                return `
                        <tr> <td> ${item.name} </td> 
                            <td> ${item.sell_in}  </td>
                            <td> ${item.quality}  </td>
                        </tr>
                        `;
            }).join('');
        }

        // POST
        // curl -d name="Conjured Mana Cake" -d sell_in=5 -d quality=8
        // http://192.168.0.19:5000/items

        //let data = {name: "Conjured Mana Cake",
          //          sell_in: 5,
          //          quality: 8};

        let formulario = document.querySelector('.add-item');
        formulario.addEventListener('submit', addItem);

        function addItem(e) {
            e.preventDefault();
            // elementos del formulario en un array-like object:
            // form.elements 
            // pag 396 libro rhino
            logForm();

            let data = { name: this.elements.name.value,
                         // sellin => bad request, status 400
                         // sin valor => mensaje del servidor en consola
                         // en XHR and fetch: message: {sell_in: "sellIn required"}
                         sell_in: this.elements.sell_in.value,
                         quality: this.elements.quality.value};

            fetch('http://127.0.0.1:5000/items', {
                method: 'POST', // or 'PUT'
                body: JSON.stringify(data), // data can be `string` or {object}!
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then((response) => {
                    if (response.ok) {
                        console.log("Response OK Status:", response.status);
                        console.log("Reponse OK status text:", response.statusText);
                    } else {
                        console.log("Response Status:", response.status);
                        console.log("Reponse statuts text:", response.statusText);
                    }
                })
                .catch((error) => {
                    console.log(error.message);
                });
        }
      
        // DELETE
        // curl -d name="Conjured Mana Cake" -d sell_in=5 -d quality=8
        // http://127.0.0.1/items -X DELETE

        formulario.deleteItem.addEventListener('click', deleteItemPromise);

        function deleteItem() {
            // elementos del formulario en un array-like object:
            // form.elements 
            // pag 396 libro rhino
            logForm();

            let data = { name: formulario.elements.name.value,
                         // sellin => bad request, status 400
                         // sin valor => mensaje del servidor en consola
                         // en XHR and fetch: message: {sell_in: "sellIn required"}
                         sell_in: formulario.elements.sell_in.value,
                         quality: formulario.elements.quality.value };

            fetch('http://127.0.0.1:5000/items', {
                method: 'DELETE',
                body: JSON.stringify(data), // data can be `string` or {object}!
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then((response) => {
                    if (response.ok) {
                        console.log("Response OK Status:", response.status);
                        console.log("Reponse OK status text:", response.statusText);
                    } else {
                        console.log("Response Status:", response.status);
                        console.log("Reponse statuts text:", response.statusText);
                    }
                })
                .catch((error) => {
                    console.log(error.message);
                });
        }

        // delete Item con promesas
        
        function deleteItemPromise() {
            // elementos del formulario en un array-like object:
            // form.elements 
            // pag 396 libro rhino
            logForm();

            let data = { name: formulario.elements.name.value,
                         // sellin => bad request, status 400
                         // sin valor => mensaje del servidor en consola
                         // en XHR and fetch: message: {sell_in: "sellIn required"}
                         sell_in: formulario.elements.sell_in.value,
                         quality: formulario.elements.quality.value };
            
            const promesa = new Promise((resolve, reject) => {
                    
                    fetch('http://127.0.0.1:5000/items', {
                        method: 'DELETE',
                        body: JSON.stringify(data), // data can be `string` or {object}!
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then((response) => {
                        if (response.ok) {
                            setTimeout(() => { resolve(response.statusText)}, 5000);
                        } else {
                            reject(response.statusText);
                        }
                    })
                });
            
            promesa.then(statusText => console.log(`"Item eliminado: ${statusText}`))
                   .then(() => inventario())
                   .catch((statusText) => {
                        console.log(`Item NO borrado: ${statusText}`);
                    });

            console.log("El cÃ³digo sigue sin esperar al setTimeout");              
        }


        function logForm() {
            // for sobre form.elements no sirve
            // porque muestra buttons tb
            let formulario = document.querySelector('.add-item');
            console.log( formulario.elements.name.value,
                         formulario.elements.sell_in.value,
                         formulario.elements.quality.value);
        }
    </script>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  </body>
</html>